{%- capture gate_password_hashes -%}
  [{% for pw in gate_object.metafields.custom.page_password.value %}"{{ pw | sha256 }}"{% unless forloop.last %},{% endunless %}{% endfor %}]
{%- endcapture -%}

<style>
  .password-gate-active .password-gate-content {
    visibility: hidden;
    height: 0;
    overflow: hidden;
    margin: 0;
    padding: 0;
  }
  .password-gate {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    padding: 2rem;
  }
  .password-gate__inner {
    text-align: center;
    max-width: 400px;
    width: 100%;
  }
  .password-gate__title {
    margin-bottom: 0.5rem;
  }
  .password-gate__message {
    margin-bottom: 1.5rem;
    color: var(--link-a70, #666);
  }
  .password-gate__form {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
  }
  .password-gate__input-wrap {
    position: relative;
    flex: 1;
    max-width: 260px;
  }
  .password-gate__input {
    padding: 0.75rem 1rem;
    padding-right: 2.5rem;
    border: 1px solid var(--border, #ccc);
    background: var(--bg, #fff);
    font-family: inherit;
    font-size: inherit;
    width: 100%;
    box-sizing: border-box;
  }
  .password-gate__toggle {
    position: absolute;
    right: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
    color: var(--link-a70, #666);
  }
  .password-gate__toggle svg {
    width: 20px;
    height: 20px;
  }
  .password-gate__toggle .icon-eye-off {
    display: none;
  }
  .password-gate__submit {
    padding: 0.75rem 1.5rem;
    background: var(--accent, #000);
    color: var(--bg, #fff);
    border: none;
    cursor: pointer;
    font-family: inherit;
    font-size: inherit;
  }
  .password-gate__submit:hover {
    opacity: 0.85;
  }
  .password-gate__error {
    display: none;
    color: #c00;
    margin-top: 1rem;
    font-size: 0.875rem;
  }
</style>

<password-gate data-password-hashes='{{ gate_password_hashes }}' data-gate-handle="{{ gate_object.handle }}">
  <div class="password-gate">
    <div class="password-gate__inner">
      <h2 class="password-gate__title">If you are a Cafe partner, please enter your password.</h2>
      <p class="password-gate__message">This page requires a password to view.</p>
      <form class="password-gate__form" action="#">
        <div class="password-gate__input-wrap">
          <input
            type="password"
            class="password-gate__input"
            placeholder="Enter password"
            autocomplete="off"
            required
          >
          <button type="button" class="password-gate__toggle" aria-label="Show password">
            <svg class="icon-eye" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            <svg class="icon-eye-off" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
          </button>
        </div>
        <button type="submit" class="password-gate__submit">Enter</button>
      </form>
      <p class="password-gate__error">Incorrect password. Please try again.</p>
    </div>
  </div>
</password-gate>

<script>
  if (!customElements.get('password-gate')) {
    customElements.define('password-gate', class extends HTMLElement {
      connectedCallback() {
        if (window.Shopify && Shopify.designMode) {
          this.unlock();
          return;
        }

        this.hashes = JSON.parse(this.dataset.passwordHashes);

        var alreadyUnlocked = this.hashes.some(function(hash) {
          return sessionStorage.getItem('gate_hash_' + hash) === 'true';
        });

        if (alreadyUnlocked) {
          this.unlock();
          return;
        }

        this.form = this.querySelector('.password-gate__form');
        this.input = this.querySelector('.password-gate__input');
        this.error = this.querySelector('.password-gate__error');
        this.toggle = this.querySelector('.password-gate__toggle');
        this.form.addEventListener('submit', this.handleSubmit.bind(this));

        this.toggle.addEventListener('click', function() {
          var isHidden = this.input.type === 'password';
          this.input.type = isHidden ? 'text' : 'password';
          this.toggle.querySelector('.icon-eye').style.display = isHidden ? 'none' : '';
          this.toggle.querySelector('.icon-eye-off').style.display = isHidden ? '' : 'none';
          this.toggle.setAttribute('aria-label', isHidden ? 'Hide password' : 'Show password');
        }.bind(this));
      }

      async handleSubmit(e) {
        e.preventDefault();
        var value = this.input.value;
        if (!value) return;

        var encoded = new TextEncoder().encode(value);
        var hashBuffer = await crypto.subtle.digest('SHA-256', encoded);
        var hashArray = Array.from(new Uint8Array(hashBuffer));
        var hashHex = hashArray.map(function(b) { return b.toString(16).padStart(2, '0'); }).join('');

        if (this.hashes.includes(hashHex)) {
          sessionStorage.setItem('gate_hash_' + hashHex, 'true');
          this.unlock();
        } else {
          this.error.style.display = 'block';
          this.input.value = '';
          this.input.focus();
        }
      }

      unlock() {
        var wrapper = this.closest('.password-gate-wrapper');
        if (wrapper) wrapper.classList.remove('password-gate-active');
        this.style.display = 'none';
      }
    });
  }
</script>
